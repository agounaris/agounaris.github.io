<!doctype html><html lang=en-us><head><title>Migrate legacy md5 passwords to sha on symfony and fos user bundle &#183; Argys Corner</title><meta name=generator content="Hugo 0.82.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=author content="Argyrios Gounaris"><meta name=description content><link rel=canonical href=https://agounaris.github.io/1/01/01/migrate-legacy-md5-passwords-to-sha-on-symfony-and-fos-user-bundle/><link rel=icon href=https://agounaris.github.io/favicon.ico><link rel=apple-touch-icon href=https://agounaris.github.io/apple-touch-icon.png><link rel=stylesheet href=https://agounaris.github.io/css/style.css><link rel=stylesheet href=https://agounaris.github.io/css/font-awesome.min.css><link rel=stylesheet href=https://agounaris.github.io/css/monokai.css><link rel=stylesheet href=https://agounaris.github.io/fancybox/jquery.fancybox.css><link href="https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600" rel=stylesheet type=text/css><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel=stylesheet type=text/css><meta property="og:title" content="Migrate legacy md5 passwords to sha on symfony and fos user bundle"><meta property="og:description" content="+++ title = &ldquo;Migrate legacy md5 passwords to sha on symfony and fos user bundle&rdquo; date = 2015-02-02T02:13:50Z author = &ldquo;Argyrios Gounaris&rdquo; +++
Recently I came upon a problem where the passwords of the current user base are hashed in md5 and we had to migrate them to sha. Checking around the web how others have solved this didn&rsquo;t help a lot. Asking your user to login to change the password or double encode the md5 one didn&rsquo;t sound like clever solutions."><meta property="og:type" content="article"><meta property="og:url" content="https://agounaris.github.io/1/01/01/migrate-legacy-md5-passwords-to-sha-on-symfony-and-fos-user-bundle/"><meta property="article:section" content="post"><meta itemprop=name content="Migrate legacy md5 passwords to sha on symfony and fos user bundle"><meta itemprop=description content="+++ title = &ldquo;Migrate legacy md5 passwords to sha on symfony and fos user bundle&rdquo; date = 2015-02-02T02:13:50Z author = &ldquo;Argyrios Gounaris&rdquo; +++
Recently I came upon a problem where the passwords of the current user base are hashed in md5 and we had to migrate them to sha. Checking around the web how others have solved this didn&rsquo;t help a lot. Asking your user to login to change the password or double encode the md5 one didn&rsquo;t sound like clever solutions."><meta itemprop=wordCount content="215"><meta itemprop=keywords content="php,symfony,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Migrate legacy md5 passwords to sha on symfony and fos user bundle"><meta name=twitter:description content="+++ title = &ldquo;Migrate legacy md5 passwords to sha on symfony and fos user bundle&rdquo; date = 2015-02-02T02:13:50Z author = &ldquo;Argyrios Gounaris&rdquo; +++
Recently I came upon a problem where the passwords of the current user base are hashed in md5 and we had to migrate them to sha. Checking around the web how others have solved this didn&rsquo;t help a lot. Asking your user to login to change the password or double encode the md5 one didn&rsquo;t sound like clever solutions."><meta name=twitter:site content="@gohugoio"><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js></script></head><body><div class=container><div id=container><header id=header><div id=header-main class=header-inner><div class=outer><a href=https://agounaris.github.io/ id=logo><i class=logo style=background-image:url(https://agounaris.github.io/css/images/logo.png)></i>
<span class=site-title>Argys Corner</span></a><nav id=main-nav><a class=main-nav-link href=https://agounaris.github.io/>Home</a>
<a class=main-nav-link href=https://agounaris.github.io/tags/>Tags</a>
<a class=main-nav-link href=https://agounaris.github.io/categories/>Categories</a></nav><nav id=sub-nav><div class=profile id=profile-nav><a id=profile-anchor href=javascript:;><img class=avatar src=https://agounaris.github.io/css/images/avatar.png><i class="fa fa-caret-down"></i></a></div></nav><div id=search-form-wrap><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder>
<button type=submit class=search-form-submit></button>
<input type=hidden name=sitesearch value=https://agounaris.github.io/></form></div></div></div><div id=main-nav-mobile class="header-sub header-inner"><table class="menu outer"><tbody><tr><td><a class=main-nav-link href=https://agounaris.github.io/>Home</a></td><td><a class=main-nav-link href=https://agounaris.github.io/tags/>Tags</a></td><td><a class=main-nav-link href=https://agounaris.github.io/categories/>Categories</a></td><td><form action=//google.com/search method=get accept-charset=utf-8 class=search-form><input type=search name=q class=search-form-input placeholder=Search>
<input type=hidden name=sitesearch value=https://agounaris.github.io/></form></td></tr></tbody></table></div></header><div class=outer><aside id=profile><div class="inner profile-inner"><div class="base-info profile-block"><img id=avatar src="https://www.gravatar.com/avatar/4fca794da0cf08804f99048d3c8b39c1?s=100&d=identicon"><h2 id=name>Argyrios Gounaris</h2><h3 id=title>Blogger - Programmer - Gopher</h3><span id=location><i class="fa fa-map-marker"></i>Earth</span>
<a id=follow href=https://github.com/gohugoio></a></div><div class="article-info profile-block"><div class=article-info-block>18
<span></span></div><div class=article-info-block>3
<span></span></div></div><div class="profile-block social-links"><table><tr><td><a href=//github.com/gohugoio target=_blank title=GitHub><i class="fa fa-github"></i></a></td><td><a href=//twitter.com/gohugoio target=_blank title=Twitter><i class="fa fa-twitter"></i></a></td><td><a href=https://agounaris.github.io/index.xml target=_blank title=RSS><i class="fa fa-rss"></i></a></td></tr></table></div></div></aside><section id=main><article id=page-undefined class="article article-type-page" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><a href=https://agounaris.github.io/1/01/01/migrate-legacy-md5-passwords-to-sha-on-symfony-and-fos-user-bundle/><h1 class=article-title itemprop=name>Migrate legacy md5 passwords to sha on symfony and fos user bundle</h1></a><div class=article-meta><div class=article-date><i class="fa fa-calendar"></i>
<time datetime="0001-01-01 00:00:00 +0000 UTC" itemprop=datePublished>0001-01-01</time>
&#183;
215
&#183;
2</div><div class=article-category><i class="fa fa-tags"></i>
<a class=article-category-link href=https://agounaris.github.io/tags/php>php</a>
&#183;
<a class=article-category-link href=https://agounaris.github.io/tags/symfony>symfony</a></div></div></header><div class=article-entry itemprop=articleBody><p>+++
title = &ldquo;Migrate legacy md5 passwords to sha on symfony and fos user bundle&rdquo;
date = 2015-02-02T02:13:50Z
author = &ldquo;Argyrios Gounaris&rdquo;
+++</p><p>Recently I came upon a problem where the passwords of the current user base are hashed in md5 and we had to migrate them to sha. Checking around the web how others have solved this didn&rsquo;t help a lot. Asking your user to login to change the password or double encode the md5 one didn&rsquo;t sound like clever solutions.</p><p>The main authentication process in symfony is happening in DaoAuthenticationProvider.</p><p>{% highlight php startinline=true %}
if (!$this->encoderFactory->getEncoder($user)->isPasswordValid($user->getPassword(), $presentedPassword, $user->getSalt())) {
throw new BadCredentialsException(&lsquo;The presented password is invalid.');
}
{% endhighlight %}</p><p>What I end up doing is to actually leave this as a final password check but prior to that authenticate the user once with the md5 and generate the sha with the given password. On the same I clear the legacy md5 field in order to know which users are actually updated and prevent the
check of happening again in the future.</p><p>{% highlight php startinline=true %}
if ("" !== ($legacyPassword = $user->getLegacyPassword())) {
if ($legacyPassword === hash(&lsquo;md5&rsquo;, $presentedPassword)) {
$user->setPlainPassword($presentedPassword);
$user->setLegacyPassword(null);
$this->userManager->updateUser($user);
}
}</p><p>if (!$this->encoderFactory->getEncoder($user)->isPasswordValid($user->getPassword(), $presentedPassword, $user->getSalt())) {
throw new BadCredentialsException(&lsquo;The presented password is invalid.');
}
{% endhighlight %}</p><p>Cheers</p></div><footer class=article-footer><a data-url=https://agounaris.github.io/1/01/01/migrate-legacy-md5-passwords-to-sha-on-symfony-and-fos-user-bundle/ data-id=d7b3ff7d7e598e735f486ccc00b808aa class=article-share-link><i class="fa fa-share"></i></a>
<script>(function(a){if(typeof __SHARE_BUTTON_BINDED__=='undefined'||!__SHARE_BUTTON_BINDED__)__SHARE_BUTTON_BINDED__=!0;else return;a('body').on('click',function(){a('.article-share-box.on').removeClass('on')}).on('click','.article-share-link',function(i){var d,f,c,e,g,b,h;if(i.stopPropagation(),d=a(this),f=d.attr('data-url'),c=encodeURIComponent(f),e='article-share-box-'+d.attr('data-id'),g=d.offset(),a('#'+e).length){if(b=a('#'+e),b.hasClass('on')){b.removeClass('on');return}}else h=['<div id="'+e+'" class="article-share-box">','<input class="article-share-input" value="'+f+'">','<div class="article-share-links">','<a href="https://twitter.com/intent/tweet?url='+c+'" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>','<a href="https://www.facebook.com/sharer.php?u='+c+'" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>','<a href="http://pinterest.com/pin/create/button/?url='+c+'" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>','<a href="https://plus.google.com/share?url='+c+'" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>','</div>','</div>'].join(''),b=a(h),a('body').append(b);a('.article-share-box.on').hide(),b.css({top:g.top+25,left:g.left}).addClass('on')}).on('click','.article-share-box',function(a){a.stopPropagation()}).on('click','.article-share-box-input',function(){a(this).select()}).on('click','.article-share-box-link',function(a){a.preventDefault(),a.stopPropagation(),window.open(this.href,'article-share-box-window-'+Date.now(),'width=500,height=450')})})(jQuery)</script></footer></div><nav id=article-nav><a href=https://agounaris.github.io/1/01/01/asynchronous-tasks-with-python3-concurrent-futures/ id=article-nav-newer class=article-nav-link-wrap><strong class=article-nav-caption></strong><div class=article-nav-title>Asynchronous tasks with python3 concurrent futures</div></a></nav></article></section><aside id=sidebar><div class=widget-wrap><h3 class=widget-title></h3><div class=widget><ul id=recent-post><li><div class=item-thumbnail><a href=https://agounaris.github.io/2017/05/01/stock-symbol-time-series-analysis-and-prediction-with-arima-model/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://agounaris.github.io/2017/05/01/stock-symbol-time-series-analysis-and-prediction-with-arima-model/ class=title>Stock symbol time series analysis and prediction with ARIMA model</a></p><p class=item-date><time datetime="2017-05-01 12:00:50 +0000 UTC" itemprop=datePublished>2017-05-01</time></p></div></li><li><div class=item-thumbnail><a href=https://agounaris.github.io/page/projects/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://agounaris.github.io/page/projects/ class=title>Projects</a></p><p class=item-date><time datetime="2015-04-03 02:13:50 +0000 UTC" itemprop=datePublished>2015-04-03</time></p></div></li><li><div class=item-thumbnail><a href=https://agounaris.github.io/page/contact/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://agounaris.github.io/page/contact/ class=title>Contact</a></p><p class=item-date><time datetime="2015-04-03 02:13:50 +0000 UTC" itemprop=datePublished>2015-04-03</time></p></div></li><li><div class=item-thumbnail><a href=https://agounaris.github.io/page/about/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://agounaris.github.io/page/about/ class=title>About</a></p><p class=item-date><time datetime="2015-04-03 02:13:50 +0000 UTC" itemprop=datePublished>2015-04-03</time></p></div></li><li><div class=item-thumbnail><a href=https://agounaris.github.io/2015/02/28/one-year-developing-with-elasticsearch/ class=thumbnail><span class="thumbnail-image thumbnail-none"></span></a></div><div class=item-inner><p class=item-title><a href=https://agounaris.github.io/2015/02/28/one-year-developing-with-elasticsearch/ class=title>One year developing with Elasticsearch</a></p><p class=item-date><time datetime="2015-02-28 02:13:50 +0000 UTC" itemprop=datePublished>2015-02-28</time></p></div></li></ul></div></div><div class=widget-wrap><h3 class=widget-title></h3><div class=widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=https://agounaris.github.io/tags/php>php</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://agounaris.github.io/tags/python>python</a>
<span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=https://agounaris.github.io/tags/symfony>symfony</a>
<span class=category-list-count>1</span></li></ul></div></div><div class=widget-wrap><h3 class=widget-title></h3><div class="widget tagcloud"><a href=https://agounaris.github.io/tags/php style=font-size:12px>php</a>
<a href=https://agounaris.github.io/tags/python style=font-size:12px>python</a>
<a href=https://agounaris.github.io/tags/symfony style=font-size:12px>symfony</a></div></div><div id=toTop class="fa fa-angle-up"></div></aside></div></div><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2021
Powered by <a href=//gohugo.io>Hugo</a>. Theme by <a href=https://github.com/ppoffice>PPOffice</a>.</div></div></footer><script src=https://agounaris.github.io/fancybox/jquery.fancybox.pack.js></script><script src=https://agounaris.github.io/js/script.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>